version: '3'
services:
  db:
   image: postgres:9.4
   volumes:
         - ./data/pg_data:/var/lib/postgresql/data/
   ports:
     - "5432:5432"
   environment:
         - POSTGRES_DB=contacts_db
         - POSTGRES_USER=postgres
         - POSTGRES_PASSWORD=

  api:
    build:
      context: .
    volumes:
      - .:/go/src/github.com/contacts_api_go/
    ports:
      - "5000:5000"
    depends_on:
      - db

  grafana:
      image: matisq/grafana:latest
      ports:
          - 3000:3000
      links:
          - influxdb:influxdb
      environment:
          GF_INSTALL_PLUGINS: "grafana-influxdb-08-datasource,natel-influx-admin-panel"
          GF_SECURITY_ADMIN_USER: admin
          GF_SECURITY_ADMIN_PASSWORD: admin
          GF_SECURITY_SECRET_KEY: grafana
          GF_USERS_ALLOW_SIGN_UP: "true"
          GF_USERS_ALLOW_ORG_CREATE: "true"
          GF_AUTH_ANONYMOUS_ENABLED: "true"
          GF_AUTH_ANONYMOUS_ORG_NAME: grafana
          GF_DASHBOARDS_JSON_ENABLED: "true"
          GF_DASHBOARDS_JSON_PATH: /opt/grafana
      volumes:
           - ./data/grafana_data:/var/lib/grafana
           - ./data/grafana_data/log:/var/log/grafana
           - ./data/grafana_data/plugins:/var/lib/grafana/plugins
      restart: always

  influxdb:
      image: matisq/influxdb:latest
      ports:
          - 8083:8083
          - 8086:8086
      environment:
          INFLUX_DATABASE: "telegraf"
          INLFUX_ADMIN_USER: "grafana"
          INFLUX_ADMIN_PASS: "grafana"
      volumes:
          - ./data/influx_data:/var/lib/influxdb


  influxdb-cli:
      image: influxdb:1.3.5
      entrypoint:
        - influx
        - -host
        - influxdb
      links:
        - influxdb

  telegraf:
      image: telegraf:1.4.0
      volumes:
        - ./tig-stack/etc/telegraf.conf:/etc/telegraf/telegraf.conf
      links:
        - influxdb
      ports:
        - "8092:8092/udp"
        - "8094:8094"
        - "8125:8125/udp"

